# SQLite batch connection support preview 2020-01

**Author:** Christopher J. Brody <mailto:chris.brody+brodybits@gmail.com>

**License:** MIT with commercial license option available

**IMPORTANT UPGRADE NOTICE:** It is highly recommended to avoid breaking schema changes, database file name changes, and database directory path changes. Upgrades need to account for any old schema versions and database file paths that may still be in use. It is possible for users to upgrade at any time, even after many years.

**IMPORTANT CORRUPTION NOTICE 1:** SQLite database corruption is possible if accessed from multiple libraries, for example using both this library and built-in `android.sqlite.database` on Android ref:
- <https://ericsink.com/entries/multiple_sqlite_problem.html>
- <https://www.sqlite.org/faq.html#q5>
- <https://github.com/xpbrew/cordova-sqlite-storage/issues/626>

**IMPORTANT CORRUPTION NOTICE 2:** It is **highly** recommended to use `-DSQLITE_DEFAULT_SYNCHRONOUS=3` build setting to be extra-durable against crashes and power loss ref:
- <https://github.com/xpbrew/cordova-sqlite-storage-help/issues/34>
- <https://github.com/xpbrew/cordova-sqlite-storage/issues/736>
- <http://sqlite.1065341.n5.nabble.com/Is-WAL-mode-more-robust-against-corruption-td99624.html>

## About

Low-level SQLite connection library for C, C++, Objective-C, and Java

to support SQLite batch processing in higher-level app frameworks such as Apache Cordova

with demonstration of use in an extremely simple Cordova plugin for mobile apps in JavaScript

designed to be thread-safe

with support available here: <https://github.com/brodybits/ask-me-anything/issues>

## Contents

- `sqlite-connection-core.h` - main low-level C API header
- `sqlite-connection-core.c` - main low-level C library source module
- `ctest` - test of main low-level C library
- `sccglue` - low-level Java API wrapper generated with help from GlueGen from jogamp.org, with JNI test
- `cordova-demo` - extremely simple Cordova demo app for testing, reformatted by `prettier-standard`, includes Cordova demo plugin:
  - `cordova-sqlite-demo-plugin` - extremely simple Cordova plugin that can open a SQLite database, execute a set of batch statements with parameters, and send the results to the Cordova JavaScript app
- with some other top-level Makefile artifacts included

## Major features

- API designed to work with integer connection ID that is easy to use from C API or Java wrapper generated by GlueGen
- able to bind 64-bit integer, double-precision float, text string, or null values to SQL statemeents with `?` placeholders
- able to retrieve one or multiple rows of results with 64-bit integer, double-precision floating point, text string, or null values
- able to get last insert row ID and total number of changes which are needed to help match some of the capabilities of the *deprecated draft* Web SQL specification
- extremely simple, rudimentary error handling

## Some known limitations

- In case of Apache Cordova, a helper plugin such as `cordova-sqlite-storage-file` should be used to resolve an absolute database file path before opening it.
- not able to close database connection and release internal resources
- hard limit of 5000 open SQLite database connections, which can be changed by defining `SCC_MAXIMUM_CONNECTIONS` to configure the hard limit when building
- The API was not designed to support parallel database access through the same database connection. For parallel database access it is recommended to open multiple SQLite connections to the same database file name.
- A limited number of historical SQLite features are disabled since the `SQLITE_DBCONFIG_DEFENSIVE` option is enabled (unless `NO_SCC_DBCONFIG_DEFENSIVE` is defined when building) ref: <https://www.sqlite.org/c3ref/c_dbconfig_defensive.html#sqlitedbconfigdefensive>
- Background threading would need to be done in a higher-level component.
- The required `scc_init()` initialization function should be called from the main thread upon startup, is **NOT** thread-safe.
- The `sqlite-connection-core.h` API header file and Java interface class have very limited documentation comments.
- Formal documentation of the API is missing here.
- The Cordova demo plugin defines multiple functions on the global `window` object, should export the functions through a single object instead.

## Samples

### C API sample

```c
#include "sqlite-connection-core.h"

#include <stdio.h>

#include <stdlib.h>

#include <string.h>

static void demo() {
  const int connection_id = scc_open_connection(":memory:", 2);

  int result_check;

  if (connection_id < 0) {
    fprintf(stderr, "could not open connection");
    exit(1);
  }

  result_check = scc_begin_statement(connection_id,
    "SELECT UPPER(?) AS result1, -? as result2");
  if (result_check != 0) {
    fprintf(stderr, "could not prepare statement");
    exit(1);
  }

  result_check = scc_bind_text(connection_id, 1, "Test");
  if (result_check != 0) {
    fprintf(stderr, "could not bind text");
    exit(1);
  }

  result_check = scc_bind_double(connection_id, 2, 123.456789);
  if (result_check != 0) {
    fprintf(stderr, "could not bind double");
    exit(1);
  }

  // should get rows:
  while (scc_step(connection_id) == 100) {
    int column_index;
    const int column_count = scc_get_column_count(connection_id);

    printf("column count: %d\n", column_count);

    for (column_index = 0; column_index < column_count; ++column_index) {
      int column_type;

      printf("column index: %d\n", column_index);

      column_type = scc_get_column_type(connection_id, column_index);

      printf("  column type: %d\n", column_index);

      if (column_type == SCC_COLUMN_TYPE_FLOAT ||
          column_type == SCC_COLUMN_TYPE_INTEGER) {
        double doubleValue = scc_get_column_double(connection_id, column_index);
        printf("  double column value: %lf\n", doubleValue);
      } else {
        const char * textValue =
          scc_get_column_text(connection_id, column_index);
        printf("  text value: %s\n", textValue);
      }
    }
  }

  scc_end_statement(connection_id);
}

int main(int argc, char ** argv) {
  scc_init();
  demo();
}
```

### Java API sample

```java
import io.sqlc.SCCoreGlue;

class SQLiteDemo {
  public static void main(String [] args) {
    final int connection_id = SCCoreGlue.scc_open_connection(":memory:", 2);

    if (connection_id < 0) {
      throw new RuntimeException("could not open connection");
    }

    int resultCheck;

    resultCheck = SCCoreGlue.scc_begin_statement(connection_id,
      "SELECT UPPER(?) AS result1, -? as result2");
    if (resultCheck != 0) {
      throw new RuntimeException("could not prepare statement");
    }

    resultCheck = SCCoreGlue.scc_bind_text(connection_id, 1, "Test");
    if (resultCheck != 0) {
      throw new RuntimeException("could not bind text");
    }

    resultCheck = SCCoreGlue.scc_bind_double(connection_id, 2, 123.456789);
    if (resultCheck != 0) {
      throw new RuntimeException("could not bind double");
    }

    // should get rows:
    while (SCCoreGlue.scc_step(connection_id) == 100) {
      final int column_count = SCCoreGlue.scc_get_column_count(connection_id);

      System.out.println("column count: " + column_count);

      for (int column_index = 0; column_index < column_count; ++column_index) {
        System.out.println("column index: " + column_index);

        int column_type =
          SCCoreGlue.scc_get_column_type(connection_id, column_index);

        System.out.println("  column type: " + column_index);

        if (column_type == SCCoreGlue.SCC_COLUMN_TYPE_FLOAT ||
            column_type == SCCoreGlue.SCC_COLUMN_TYPE_INTEGER) {
          double doubleValue =
            SCCoreGlue.scc_get_column_double(connection_id, column_index);
          System.out.println("  double column value: " + doubleValue);
        } else {
          String textValue =
            SCCoreGlue.scc_get_column_text(connection_id, column_index);
          System.out.println("  text value: " + textValue);
        }
      }
    }

    SCCoreGlue.scc_end_statement(connection_id);
  }

  static {
    System.loadLibrary("sqlite-connection-core-glue");
    SCCoreGlue.scc_init();
  }
}
```

### API sample output

The C and Java samples above would both show the following output:

```
column count: 2
column index: 0
  column type: 0
  text value: TEST
column index: 1
  column type: 1
  double column value: -123.456789
```

### Apache Cordova demo app

Demonstrates accessing database files from an Apache Cordova application, with help from the `cordova-sqlite-storage-file` and `cordova-plugin-file` plugins.

#### index.html

```html
<html>
  <head>
    <link rel="stylesheet" href="body.css" />
  </head>

  <body>
    <font face="Arial" />
    <h1>Cordova demo app</h1>
    <div id="messages" />
  </body>

  <script src="cordova.js"></script>
  <script src="app.js"></script>
</html>
```

#### body.css

needed for the HTML body to show up on macOS ("osx")

```css
body {
  background-color: #fff;
}
```

#### app.js

```js
document.addEventListener('deviceready', onReady)

// based on some JavaScript code generated by generate-cordova-package
function log (text) {
  // log into the `messages` div:
  document.getElementById('messages').appendChild(document.createTextNode(text))
  document.getElementById('messages').appendChild(document.createElement('br'))
  // and to the console
  console.log(text)
}

const DATABASE_FILE_NAME = 'demo.db'

// SQLITE_OPEN_READWRITE | SQLITE_OPEN_CREATE
// ref: https://www.sqlite.org/c3ref/open.html
const OPEN_DATABASE_FLAGS = 6

function openFileDatabaseConnection (name, openCallback, errorCallback) {
  window.sqliteStorageFile.resolveAbsolutePath(
    {
      name: name,
      // TEMPORARY & DEPRECATED value, as needed for iOS & macOS ("osx"):
      location: 2
    },
    function (path) {
      log('database file path: ' + path)

      window.openDatabaseConnection(
        { path: path, flags: OPEN_DATABASE_FLAGS },
        openCallback,
        errorCallback
      )
    }
  )
}

function openCacheFileDatabaseConnection (name, openCallback, errorCallback) {
  window.resolveLocalFileSystemURL(
    // portable across Android, iOS, & macOS ("osx"):
    cordova.file.cacheDirectory,
    function (entry) {
      const dataDirectoryUrl = entry.toURL()

      log('data directory url: ' + dataDirectoryUrl)

      // hacky, working solution:
      const path = dataDirectoryUrl.substring(7) + name

      log('database cache file path: ' + path)

      window.openDatabaseConnection(
        { path: path, flags: OPEN_DATABASE_FLAGS },
        openCallback,
        errorCallback
      )
    }
  )
}

function onReady () {
  log('deviceready event received')

  // for SQLite database file:
  openFileDatabaseConnection(DATABASE_FILE_NAME, openCallback, function (
    error
  ) {
    log('UNEXPECTED OPEN ERROR: ' + error)
  })
}

function openCallback (connectionId) {
  log('open connection id: ' + connectionId)

  // ERROR TEST - file name with incorrect flags:
  window.openDatabaseConnection(
    { path: 'dummy.db', flags: 0 },
    function (_ignored) {
      log('FAILURE - unexpected open success callback received')
    },
    function (e) {
      log('OK - received error callback as expected for incorrect open call')

      // CONTINUE with batch demo, with the correct connectionId:
      batchDemo(connectionId)
    }
  )
}

function batchDemo (connectionId) {
  log('starting batch demo for connection id: ' + connectionId)
  window.executeBatch(
    connectionId,
    [
      ['SELECT ?, -?, LOWER(?), UPPER(?)', [null, 123.456789, 'ABC', 'Text']],
      ['SLCT 1', []],
      ['SELECT ?', ['OK', 'out of bounds parameter']],
      ['DROP TABLE IF EXISTS Testing', []],
      ['CREATE TABLE Testing (data NOT NULL)', []],
      ["INSERT INTO Testing VALUES ('test data')", []],
      ['INSERT INTO Testing VALUES (null)', []],
      ['DELETE FROM Testing', []],
      ["INSERT INTO Testing VALUES ('test data 2')", []],
      ["INSERT INTO Testing VALUES ('test data 3')", []],
      ['SELECT * FROM Testing', []],
      ["SELECT 'xyz'", []]
    ],
    batchCallback
  )
}

function batchCallback (batchResults) {
  // show batch results in JSON string format (on all platforms)
  log('received batch results')
  log(JSON.stringify(batchResults))

  startReaderDemo()
}

function startReaderDemo () {
  openFileDatabaseConnection(
    DATABASE_FILE_NAME,
    function (id) {
      log('read from another connection id: ' + id)

      window.executeBatch(id, [['SELECT * FROM Testing', []]], function (res) {
        log(JSON.stringify(res))
        startCacheFileDemo()
      })
    },
    function (error) {
      log('UNEXPECTED OPEN ERROR: ' + error)
    }
  )
}

function startCacheFileDemo () {
  openCacheFileDatabaseConnection(
    DATABASE_FILE_NAME,
    function (id) {
      log('cache file database connection id: ' + id)

      window.executeBatch(
        id,
        [
          ['DROP TABLE IF EXISTS Testing', []],
          ['CREATE TABLE Testing (data NOT NULL)', []],
          ["INSERT INTO Testing VALUES ('test data')", []],
          ['SELECT * FROM Testing', []]
        ],
        function (results) {
          log(JSON.stringify(results))
        }
      )
    },
    function (error) {
      log('UNEXPECTED OPEN ERROR: ' + error)
    }
  )
}
```

#### expected Cordova batch results

first set in JSON string format (reformatted by `prettier-standard`):

```json
[
  {
    "status": 0,
    "columns": ["?", "-?", "LOWER(?)", "UPPER(?)"],
    "rows": [[null, -123.456789, "abc", "TEXT"]]
  },
  { "status": 1, "message": "near \"SLCT\": syntax error" },
  { "status": 1, "message": "column index out of range" },
  { "status": 0, "total_changes": 0, "last_insert_rowid": 0 },
  { "status": 0, "total_changes": 0, "last_insert_rowid": 0 },
  { "status": 0, "total_changes": 1, "last_insert_rowid": 1 },
  { "status": 1, "message": "NOT NULL constraint failed: Testing.data" },
  { "status": 0, "total_changes": 2, "last_insert_rowid": 1 },
  { "status": 0, "total_changes": 3, "last_insert_rowid": 1 },
  { "status": 0, "total_changes": 4, "last_insert_rowid": 2 },
  {
    "status": 0,
    "columns": ["data"],
    "rows": [["test data 2"], ["test data 3"]]
  },
  { "status": 0, "columns": ["'xyz'"], "rows": [["xyz"]] }
]
```

second set (in JSON string format, reformatted by `prettier-standard`):

```json
[
  {
    "status": 0,
    "columns": ["data"],
    "rows": [["test data 2"], ["test data 3"]]
  }
]
```
results from cache database file demo:


```json
[
  { "status": 0, "total_changes": 0, "last_insert_rowid": 0 },
  { "status": 0, "total_changes": 0, "last_insert_rowid": 0 },
  { "status": 0, "total_changes": 1, "last_insert_rowid": 1 },
  { "status": 0, "columns": ["data"], "rows": [["test data"]] }
]
```

## Testing

### C test

- `cd ctest`
- `make test`

### Java JNI test

intended for testing on macOS only:

- `cd sccglue`
- `make test`

### Running Cordova demo

prerequisites:

- *recommended:* use macOS to build and run on all Cordova platforms
- install Apache Cordova using npm (`npm i -g cordova`)
- install Android SDK and NDK
- *recommended:* install Xcode

how:

- `(cd sccglue && make ndkbuild)`
- `cd cordova-demo`
- `make prepare-app`
- recommended: do `cordova plugin ls` to check that the demo plugin was added
- `(cordova platform add osx && cordova run osx)` to build and run on Cordova "osx" (macOS) platform
- `(cordova platform add android && cordova run android)`
- `(cordova platform add ios && cordova run ios)`

## build notes

- Makefiles are designed to fetch and extract recent SQLite amalgamation as needed to build test programs, NDK library, and Cordova demo.
